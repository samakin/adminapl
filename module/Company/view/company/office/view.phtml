<?php
$this->headTitle('Офис '.$office->getName());

$this->mainMenu()->setActiveItemId('offices');

$this->pageBreadcrumbs()->setItems([
            'Главная'=>$this->url('home'),
            'Офисы'=>$this->url('offices'),
            $office->getName()=>$this->url('offices', ['action'=>'view', 'id'=>$office->getId()])
            ]);

$this->headScript()
            ->appendFile($this->basePath('js/jquery.mask.min.js'))
        ;      

$legalContact = $office->getLegalContact();

?>


<?= $this->flashMessenger()->render('error', ['alert', 'alert-warning']); ?>
<?= $this->flashMessenger()->render('success', ['alert', 'alert-success']); ?>
<?= $this->flashMessenger()->render('info', ['alert', 'alert-info']); ?>

<div class="row">
    <div class="col-sm-9">
        <table class="table table-striped">
            <tr id="section1">
                <td>
                    <h2>Офис <?= $office->getName() ?></h2>
                </td>
                <td></td>
            </tr>
            <tr>
                <td colspan="2">
                    <div class="panel panel-default">
                        <div class="panel-body">
                            <div class="pull-left">
                                ID: <?= $this->escapeHtml($office->getId()) ?><br/>
                                Наименование: <?= $this->escapeHtml($office->getName()) ?><br/>
                                Регион: <?= $this->escapeHtml($office->getRegion()->getFullName()) ?><br/>
                                Статус: <?= $this->escapeHtml($office->getStatusAsString()) ?><br/>
                            </div>
                            <div class="pull-right">
                                <button value="/offices/edit-form/<?= $office->getId() ?>" class="btn btn-default btn-xs"
                                        data-toggle="modal" data-target="#modal-dialog" title="Изменить">
                                    <span class="glyphicon glyphicon-edit" ></span>
                                </button>                                                    
                            </div>
                        </div>
                        
                    </div>
                </td>
            </tr>

            <tr id="section2">
                <td>
                    <h3>Контактные телефоны</h3>
                </td>
                <td align="right">
                    <button value="/contact/phone-form/<?= $legalContact->getId() ?>" class="btn btn-default btn-xs"
                            data-toggle="modal" data-target="#modal-dialog" title="Добавить телефон">
                        <span class="glyphicon glyphicon-plus" ></span>
                    </button>                                        
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    <div class="panel panel-group">
                    <?php foreach ($legalContact->getPhones() as $phone): ?>
                        <div class="panel panel-default">
                            <div class="panel-body">
                                <div class="pull-left">
                                    <?= $phone->getName()?> <span><?= $phone->getComment()?></span>
                                </div>
                                <div class="pull-right">
                                    <button value="/contact/phone-form/<?= $legalContact->getId() ?>?phone=<?= ($phone ? $phone->getId():'') ?>" class="btn btn-default btn-xs phone-edit"
                                            data-toggle="modal" data-target="#modal-dialog" title="Изменить">
                                        <span class="glyphicon glyphicon-edit" ></span>
                                    </button>                                                            
                                    <button value="/contact/delete-phone-form/<?= $phone->getId() ?>" class="btn btn-default btn-xs this-delete"
                                            title="Удалить">
                                        <span class="glyphicon glyphicon-remove" ></span>
                                    </button>                                                            
                                </div>
                            </div>
                        </div>    
                    <?php endforeach; ?>
                    </div>
                </td>
            </tr>

            <tr id="section3">
                <td>
                    <h3>Электронная почта</h3>
                </td>
                <td align="right">
                    <button value="/contact/email-form/<?= $legalContact->getId() ?>" class="btn btn-default btn-xs"
                            data-toggle="modal" data-target="#modal-dialog" title="Добавить email">
                        <span class="glyphicon glyphicon-plus"></span>
                    </button>                                            
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    <div class="panel panel-group">
                    <?php foreach ($legalContact->getEmails() as $email): ?>
                        <div class="panel panel-default">
                            <div class="panel-body">
                                <div class="pull-left">
                                    <?= $email->getName()?>
                                </div>
                                <div class="pull-right">
                                    <button value="/contact/email-form/<?= $legalContact->getId() ?>?email=<?= ($email ? $email->getId():'') ?>" class="btn btn-default btn-xs email-edit"
                                            data-toggle="modal" data-target="#modal-dialog" title="Изменить">
                                        <span class="glyphicon glyphicon-edit" ></span>
                                    </button>                                                            
                                    <button value="/contact/delete-email-form/<?= $email->getId() ?>" class="btn btn-default btn-xs this-delete" title="Удалить">
                                        <span class="glyphicon glyphicon-remove"></span>
                                    </button>                                                            
                                </div>
                            </div>

                        </div>
                    <?php endforeach; ?>
                    </div>    
                </td>
            </tr>

            <tr id="section4">
                <td>
                    <h3>Мессенджеры</h3>
                </td>
                <td align="right">
                    <button value="/contact/messenger-form/<?= $legalContact->getId() ?>" class="btn btn-default btn-xs"
                            data-toggle="modal" data-target="#modal-dialog" title="Добавить мессенджер">
                        <span class="glyphicon glyphicon-plus"></span>
                    </button>                                            
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    <div class="panel panel-group">
                    <?php foreach ($legalContact->getMessengers() as $messenger): ?>
                        <div class="panel panel-default">
                            <div class="panel-body">
                                <div class="pull-left">
                                    <?= $this->escapeHtml($messenger->getTypesAsString()); ?>: <?= $this->escapeHtml($messenger->getIdent()); ?>
                                </div>
                                <div class="pull-right">
                                    <button value="/contact/messenger-form/<?= $messenger->getContact()->getId() ?>?messenger=<?= $messenger->getId() ?>" class="btn btn-default btn-xs"
                                            data-toggle="modal" data-target="#modal-dialog" title="Изменить">
                                        <span class="glyphicon glyphicon-edit" ></span>
                                    </button>                                                            
                                    <button value="/contact/delete-messenger-form/<?= $messenger->getId() ?>" class="btn btn-default btn-xs this-delete"
                                            title="Удалить">
                                        <span class="glyphicon glyphicon-remove" ></span>
                                    </button>                                                            
                                </div>
                            </div>

                        </div>
                    <?php endforeach; ?>
                    </div>     
                </td>
            </tr>
            <tr id="section5">
                <td>
                    <h3>Адреса</h3>
                </td>
                <td align="right">
                    <button value="/contact/address-form/<?= $legalContact->getId() ?>" class="btn btn-default btn-xs"
                            data-toggle="modal" data-target="#modal-dialog" title="Добавить адрес">
                        <span class="glyphicon glyphicon-plus"></span>
                    </button>                                            
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    <div class="panel panel-group">
                    <?php foreach ($legalContact->getAddresses() as $address): ?>
                        <div class="panel panel-default">
                            <div class="panel-body">
                                <div class="pull-left">
                                    <?= $this->escapeHtml($address->getName()); ?>: <?= $this->escapeHtml($address->getAddress()); ?>
                                </div>
                                <div class="pull-right">
                                    <button value="/contact/address-form/<?= $address->getContact()->getId() ?>?address=<?= $address->getId() ?>" class="btn btn-default btn-xs"
                                            data-toggle="modal" data-target="#modal-dialog" title="Изменить">
                                        <span class="glyphicon glyphicon-edit" ></span>
                                    </button>                                                            
                                    <button value="/contact/delete-address-form/<?= $address->getId() ?>" class="btn btn-default btn-xs this-delete"
                                            title="Удалить">
                                        <span class="glyphicon glyphicon-remove" ></span>
                                    </button>                                                            
                                </div>
                            </div>

                        </div>
                    <?php endforeach; ?>
                    </div>    
                </td>
            </tr>
            <tr id="section6">
                <td>
                    <h3>Юридические лица</h3>
                </td>
                <td align="right">
                    <button value="/legals/form/<?= $legalContact->getId() ?>" class="btn btn-default btn-xs"
                            data-toggle="modal" data-target="#modal-dialog" title="Добавить юридическое лицо">
                        <span class="glyphicon glyphicon-plus"></span>
                    </button>                                            
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    <?php foreach ($legalContact->getLegals() as $legal): ?>
                    <div class="panel panel-group">
                        <div class="panel panel-default">
                            <div class="panel-body">
                                <div class="pull-left">
                                    <?= $legal->getName() ?><br/>
                                    ИНН/КПП: <?= $legal->getInn() ?>/<?= $legal->getKpp() ?><br/>
                                    ОГРН: <?= $legal->getOgrn() ?><br/>
                                    ОКПО: <?= $legal->getOkpo() ?><br/>
                                    Местонахождение: <?= $legal->getAddress() ?><br/>
                                    Руководитель: <?= $legal->getHead() ?><br/>
                                    Главный бухгалтер: <?= $legal->getChiefAccount() ?><br/>
                                    Дата начала деятельности: <?= date('d.m.Y', strtotime($legal->getDateStart())); ?><br/>
                                    Статус: <?= $legal->getStatusAsString() ?><br/>
                                    Дополнительная информация: <?= $legal->getInfo() ?><br/>                            
                                </div>
                                <div class="pull-right">
                                    <button value="/legals/form/<?= $legalContact->getId() ?>?legal=<?= $legal->getId() ?>" class="btn btn-default btn-xs"
                                            data-toggle="modal" data-target="#modal-dialog" title="Изменить">
                                        <span class="glyphicon glyphicon-edit" ></span>
                                    </button>                    
                                    <button value="/legals/delete-association-form/<?= $legal->getId() ?>" class="btn btn-default btn-xs this-delete"
                                            title="Удалить">
                                        <span class="glyphicon glyphicon-remove" ></span>
                                    </button>                                                           
                                </div>
                            </div>
                        </div>
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <div class="pull-left">
                                    Банковские счета
                                </div>                                
                                <div class="pull-right">
                                    <button value="/legals/bank-account-form/<?= $legal->getId() ?>" class="btn btn-default btn-xs"
                                            data-toggle="modal" data-target="#modal-dialog" title="Добавить новый">
                                        <span class="glyphicon glyphicon-plus" ></span>
                                    </button>                                                        
                                </div>                                
                            </div>
                             <?php foreach ($legal->getBankAccounts() as $bankAccount): ?>
                                <div class="panel-body">
                                    <div class="pull-left">
                                         Банк: <?= $bankAccount->getName().' '.$bankAccount->getCity() ?><br/>
                                         БИК: <?= $bankAccount->getBik()?><br/>
                                         Расчетный счет: <?= $bankAccount->getRs()?><br/>
                                         Корр. счет: <?= $bankAccount->getKs()?><br/>
                                         Статус: <?= $bankAccount->getStatusAsString()?><br/>                               
                                    </div>
                                     <div class="pull-right">
                                         <button value="/legals/bank-account-form/<?= $legal->getId() ?>?bankAccount=<?= $bankAccount->getId() ?>" class="btn btn-default btn-xs"
                                                 data-toggle="modal" data-target="#modal-dialog" title="Изменить">
                                             <span class="glyphicon glyphicon-edit" ></span>
                                         </button>                    
                                        <button value="/legals/delete-bank-account-form/<?= $bankAccount->getId() ?>" class="btn btn-default btn-xs this-delete"
                                                title="Удалить">
                                            <span class="glyphicon glyphicon-remove" ></span>
                                        </button>                                                           
                                     </div>
                                </div>    
                             <?php endforeach; ?>
                        </div>
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <div class="pull-left">
                                    Договоры
                                </div>                                
                                <div class="pull-right">
                                    <button value="/legals/contract-form/<?= $legal->getId() ?>" class="btn btn-default btn-xs"
                                            data-toggle="modal" data-target="#modal-dialog" title="Добавить новый">
                                        <span class="glyphicon glyphicon-plus" ></span>
                                    </button>                    
                                </div>                                
                            </div>
                             <?php foreach ($legal->getContracts() as $contract): ?>
                                <div class="panel-body">
                                    <div class="pull-left">
                                        Наименование: <?= $contract->getName() ?><br/>  
                                        № <?= $contract->getAct() ?> от <?= date('d.m.Y', strtotime($contract->getDateStart())) ?>
                                    </div>
                                     <div class="pull-right">
                                        <button value="/legals/contract-form/<?= $legal->getId() ?>?contract=<?= $contract->getId() ?>" class="btn btn-default btn-xs"
                                                data-toggle="modal" data-target="#modal-dialog" title="Изменить">
                                            <span class="glyphicon glyphicon-edit" ></span>
                                        </button>                    
                                        <button value="/legals/delete-contract-form/<?= $contract->getId() ?>" class="btn btn-default btn-xs this-delete"
                                                title="Удалить">
                                            <span class="glyphicon glyphicon-remove" ></span>
                                        </button>                                                           
                                     </div>
                                </div>    
                             <?php endforeach; ?>
                        </div>                        
                    </div>
                    <?php endforeach; ?>
                </td>
            </tr>
        </table>
    </div>
    <div class="col-sm-3" id="side-nav" >
        <ul class="nav nav-stacked nav-list affix">
            <li class="active"><a href="#section1">Офис</a></li>
            <li><a href="#section2">Контакты</a></li>
            <li><a href="#section3">Адреса</a></li>
            <li><a href="#section3">Юридические лица</a></li>
        </ul>
    </div>
</div>

<div class="modal fade" id="modal-dialog" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false" aria-labelledby="" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content" id="modal-content">
        </div>
    </div>
</div>

<script>
    $('#modal-dialog').on('show.bs.modal', function (e) {        
        var url = e.relatedTarget.value;
        if (url){
            $.ajax({
                type: 'GET',
                url: url
            })
                .done(function (data) {
                   $('#modal-content').html(data);
                })
                .fail(function () {
                    alert("Ошибка открытия формы.");
                }); 
        }
    })    
        
    $('.this-delete').on('click', function(e) {
        var url = e.currentTarget.value;
        if (url){
            if (confirm('Удалить запись?')){
                $.ajax({
                    type: 'GET',
                    url: url,
                })
                    .done(function (data) {
                        if (data == 'ok'){
                            window.location.reload();
                        } else {
                            alert("Не удалось удалить!");
                        }    
                    })
                    .fail(function (e) {
                        alert("Не удалось удалить.");

                    });
            }        
        }        
    })    
    
</script>